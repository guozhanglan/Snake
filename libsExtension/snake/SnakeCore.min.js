var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},snake;!function(t){var e=function(){function t(){this.m_List=[],this.m_Map={}}return t.prototype.setVal=function(t,e){var i=this.m_Map;if(t in i){var n=i[t],r=this.m_List.indexOf(n);-1!=r&&(this.m_List[r]=e),i[t]=e}},t.prototype.add=function(t,e){return t in this.m_Map?(this.setVal(t,e),e):(this.m_List.push(e),this.m_Map[t]=e,e)},t.prototype.remove=function(t){if(t in this.m_Map){var e=this.m_List.indexOf(this.m_Map[t]);return this.m_Map[t]=null,delete this.m_Map[t],-1!=e&&this.m_List.splice(e,1),!0}return!1},t.prototype.contains=function(t){return t in this.m_Map},t.prototype.find=function(t){var e=this.m_Map[t];return void 0!=e?e:null},t.prototype.clear=function(){this.m_List.length=0,this.m_Map={}},t.prototype.size=function(){return this.m_List.length},t.prototype.list=function(){return this.m_List},t}();t.ValMap=e,__reflect(e.prototype,"snake.ValMap")}(snake||(snake={}));var snake;!function(t){var e=function(){function e(){this.m_Scenes=new t.ValMap,this.m_SceneIDCounter=1}return e.prototype.CreateScene=function(e){var i=this.m_SceneIDCounter++,n=this.m_Scenes.add(i,new t.Scene);return null!=n?(n.Initialize(e),i):0},e.prototype.DeleteScene=function(t){this.m_Scenes.remove(t)},e.prototype.GetScene=function(t){return this.m_Scenes.find(t)},e.prototype.GetAICount=function(){for(var t=0,e=this.m_Scenes.list,i=e.length,n=0;i>n;++n)t+=e[n].GetAICount();return t},e.prototype.GetPlayerCount=function(){for(var t=0,e=this.m_Scenes.list,i=e.length,n=0;i>n;++n)t+=e[n].GetPlayerCount();return t},e.prototype.GetBeanCount=function(){for(var t=0,e=this.m_Scenes.list,i=e.length,n=0;i>n;++n)t+=e[n].GetBeanCount();return t},e}();t.SceneManager=e,__reflect(e.prototype,"snake.SceneManager")}(snake||(snake={}));var snake;!function(t){var e=function(){function e(){this.m_Direction=new t.Vector2,this.m_TargetDirection=new t.Vector2,this.m_AABB=new t.AABB,this.m_Points=[],this.m_SlitherInfo=new t.SlitherInfo,this.m_BodyInfo=[]}return e.prototype.CalculatePointCount=function(){return Math.ceil(this.m_SlitherInfo.length/this.SegmentLength())},e.prototype.SegmentLength=function(){var e=this.m_pScene.Params();return t.max(e.linearSpeedNormal*e.physicsTimeStep/e.frameStep,.01)},e.prototype.UpdateBodyPointsFrame=function(){for(var t=this.m_pScene.Params(),e=this.m_Points,i=e.length-1;i>=1;--i){var n=e[i],r=e[i-1].sub(n);n.addAssignment(r.mul(t.frameStep)),e[i]=n}this.m_PointsDirty=!0},e.prototype.UpdateDevourBean=function(t,e){for(var i=.5*this.m_SlitherInfo.width*t.devourScale+t.devourBase,n=this.m_Points[0],r=this.m_pScene.Beans(),a=r.FindInRange(n,i,e,t.devourDegree),o=0,s=a.length,h=0;s>h;++h){var u=a[h];0==u.slitherID&&(o+=u.valReal,this.m_pScene.DevourBean(u,this.m_SlitherInfo.id,!1))}o>0&&this.AddScore(o)},e.prototype.UpdateBounds=function(){var t=this.m_Points.length;this.m_AABB.Clear();for(var e=0;t>e;++e)this.m_AABB.Encapuslate(this.m_Points[e]);this.m_AABB.Enlarge(.5*this.m_SlitherInfo.width)},e.prototype.UpdateEndPointIndex=function(){for(var e=0,i=this.Width()*this.m_pScene.Params().headTestEndFactor,n=this.m_Points.length,r=n-1;r>0;--r)if(e+=t.Distance(this.m_Points[r-1],this.m_Points[r]),e>i){this.m_EndPointIndex=r;break}},e.prototype.OverlapBorder=function(){var e=this.m_pScene.Params();if(e.radius<.01)return!1;var i=this.m_Points[0],n=t.Distance(i,this.m_pScene.Center())+this.m_SlitherInfo.width*(e.collisionThreshold-.5);return n>=e.radius?!0:!1},e.prototype.OverlapAnyOtherSlither=function(t){for(var e=this.m_Points[0],i=this.m_pScene.AllSlithers(),n=i.length,r=0;n>r;++r){var a=i[r];if(a.ID()!=this.m_SlitherInfo.id&&void 0==t.find(a.ID())&&a.Bounds().IntersectVec(e,.5*this.m_SlitherInfo.width)&&this.OverlapSlither(e,this.m_SlitherInfo.width,a))return a}return null},e.prototype.OverlapSlither=function(e,i,n){var r=this.m_pScene.Params(),a=.5*(n.Width()+i)*r.collisionThreshold;a*=a;for(var o=n.Points(),s=t.min(n.PointCount(),n.EndPointIndex()),h=0;s>h;++h){var u=o[h].sub(e).SquareMagnitude();if(a>u)return h<r.headTestStart?i<n.Width():!0}return!1},e.prototype.UpdateSpeed=function(e,i,n,r){this.m_TargetDirection.IsZero()&&(this.m_TargetDirection=n),this.m_SlitherInfo.accelarating?i+=e*r.linearAccelartion:i-=e*r.linearDeccelartion,i=t.clamp(i,r.linearSpeedNormal,r.linearSpeedFast);var a=(i-r.linearSpeedNormal)/(r.linearSpeedFast-r.linearSpeedNormal),o=this.Width(),s=this.m_pScene.WidthToRotateNormal(o),h=this.m_pScene.WidthToRotateFast(o),u=t.lerp(s,h,a),l=u/this.m_SlitherInfo.width,m=t.RotateTowards(n,this.m_TargetDirection,l*e);return m.mul(i)},e.prototype.Initialize=function(t,e,i,n,r,a){var o=t.GetHistorySlitherInfo(e);this.m_pScene=t,this.m_EndPointIndex=0,this.m_LastPhysicsTime=0,this.m_LastScoreLostTime=0,this.m_ScoreFactor=1,this.m_Direction=a,this.m_TargetDirection=a,this.m_PointsDirty=!0,this.m_HeadInfoDirty=!0,this.m_StateInfoDirty=!0,this.m_BodyInfoDirty=!0,this.m_SlitherInfo.id=e,this.m_SlitherInfo.skinID=i,this.m_SlitherInfo.continueKillCount=0,this.m_SlitherInfo.totalKillCount=null!=o?o.totalKillCount:0,this.m_SlitherInfo.accelarating=!1,this.m_SlitherInfo.score=n,this.m_SlitherInfo.speed=a.mul(this.m_pScene.Params().linearSpeedNormal),this.m_SlitherInfo.width=this.m_pScene.ScroreToWidth(n),this.m_SlitherInfo.length=this.m_pScene.ScoreToLength(n),this.m_SlitherInfo.head=r,this.m_SlitherInfo.inTeamNum=0,this.m_SlitherInfo.rank=0;var s=this.CalculatePointCount(),h=this.m_Points;h.length=0,h.push(r),this.m_AABB.Clear(),this.m_AABB.Encapuslate(r);for(var u=this.SegmentLength(),l=1;s>l;++l){var m=3>l?u:.001,c=h[h.length-1],f=c.sub(a.mul(m));this.m_Points.push(f),this.m_AABB.Encapuslate(f)}this.m_AABB.Enlarge(.5*this.m_SlitherInfo.width)},e.prototype.Update=function(e,i){this.m_PointsDirty=!1;var n=this.m_pScene.Params();if(this.m_SlitherInfo.accelarating){var r=n.accelarateScoreRatio*n.accelarateScoreLost/n.accelarateScoreInterval;this.SubScore(r*i)?this.m_SlitherInfo.accelarating=!1:e-this.m_LastScoreLostTime>n.accelarateScoreInterval&&(this.m_pScene.GenerateBean(this.m_Points[this.m_Points.length-1],n.accelarateScoreLost*n.scoreVisualScale,n.accelarateScoreLost),this.m_LastScoreLostTime=e)}0==this.m_LastPhysicsTime&&(this.m_LastPhysicsTime=e);var a=t.max(this.m_SlitherInfo.speed.Magnitude(),.001);this.m_Direction=this.m_SlitherInfo.speed.div(a),this.m_SlitherInfo.speed=this.UpdateSpeed(i,a,this.m_Direction,n);var o=e-this.m_LastPhysicsTime,s=n.physicsTimeStep*n.linearSpeedNormal/this.m_SlitherInfo.speed.Magnitude();if(o>s){for(var h=o/s,u=Math.floor(h),l=0;u>l;++l){this.UpdateBodyPointsFrame();var m=this.m_SlitherInfo.speed.mul(s);this.m_Points[0].addAssignment(m)}this.m_LastPhysicsTime+=u*s}this.m_SlitherInfo.head=this.m_Points[0],this.m_PointsDirty&&(this.m_HeadInfoDirty=!0,this.m_StateInfoDirty=!0,this.m_BodyInfoDirty=!0,this.UpdateDevourBean(n,this.m_Direction),this.UpdateBounds(),this.UpdateEndPointIndex())},e.prototype.DrawGizmo=function(t,e,i){return 0},e.prototype.UpdateCollision=function(t){if(this.m_PointsDirty)if(this.OverlapBorder())t.add(this.m_SlitherInfo.id,0),this.m_SlitherInfo.lastKillerID=0;else{var e=this.OverlapAnyOtherSlither(t);if(null!=e){var i=e.m_SlitherInfo;i.continueKillCount++,i.totalKillCount++,this.m_SlitherInfo.lastKillerID=e.ID(),t.add(this.m_SlitherInfo.id,e.ID()),this.m_pScene.GenerateBeanOnSlitherDie(this,e)}}},e.prototype.AddScore=function(t){this.m_SlitherInfo.score+=t*this.m_ScoreFactor,this.m_SlitherInfo.width=this.m_pScene.ScroreToWidth(this.m_SlitherInfo.score),this.m_SlitherInfo.length=this.m_pScene.ScoreToLength(this.m_SlitherInfo.score);var e=this.CalculatePointCount(),i=this.m_Points,n=i[i.length-1],r=n.sub(i[i.length-2]);for(r.addAssignment(.01);i.length<e;)n.addAssignment(r),i.push(n),this.m_PointsDirty=!0},e.prototype.SubScore=function(t){var e=!1,i=this.m_pScene.Params().baseScore;this.m_SlitherInfo.score-=t,this.m_SlitherInfo.score<=i&&(this.m_SlitherInfo.score=i,e=!0),this.m_SlitherInfo.width=this.m_pScene.ScroreToWidth(this.m_SlitherInfo.score),this.m_SlitherInfo.length=this.m_pScene.ScoreToLength(this.m_SlitherInfo.score);for(var n=this.CalculatePointCount();this.m_Points.length>n;)this.m_Points.pop(),this.m_PointsDirty=!0;return e},e.prototype.EndPointIndex=function(){return this.m_EndPointIndex},e.prototype.SetSlitherCmd=function(e,i){this.m_SlitherInfo.accelarating=i,this.m_TargetDirection=t.Normalize(e)},e.prototype.PointData=function(){return this.m_Points[0]},e.prototype.Points=function(){return this.m_Points},e.prototype.PointCount=function(){return this.m_Points.length},e.prototype.Position=function(){return this.m_SlitherInfo.head},e.prototype.Direction=function(){return this.m_Direction},e.prototype.Accelarating=function(){return this.m_SlitherInfo.accelarating?!0:!1},e.prototype.Width=function(){return this.m_SlitherInfo.width},e.prototype.Score=function(){return this.m_SlitherInfo.score},e.prototype.Rank=function(){return this.m_SlitherInfo.rank},e.prototype.setRank=function(t){this.m_SlitherInfo.rank=t},e.prototype.Speed=function(){return this.m_SlitherInfo.speed},e.prototype.ID=function(){return this.m_SlitherInfo.id},e.prototype.SkinID=function(){return this.m_SlitherInfo.skinID},e.prototype.Bounds=function(){return this.m_AABB},e.prototype.Info=function(){return this.m_SlitherInfo},e}();t.SlitherBase=e,__reflect(e.prototype,"snake.SlitherBase")}(snake||(snake={}));var snake;!function(t){var e=function(){function t(){}return t.prototype.operator=function(t){return!0},t}();t.DefaultFilter=e,__reflect(e.prototype,"snake.DefaultFilter");var i=function(){function e(){this.m_Min=new t.Vector2,this.m_Max=new t.Vector2,this.m_Bucket=[],this.m_CacheResult=[]}return e.prototype.GetBucketVec=function(e){var i=new t.Vector2;return this.GetBucketIndex(e,i),this.GetBucket(i.x,i.y)},e.prototype.GetBucket=function(t,e){var i=t+e*this.m_Width,n=this.m_Bucket[i];return n?n:(n=new Array,this.m_Bucket[i]=n,n)},e.prototype.GetBucketIndex=function(e,i){var n=e.sub(this.m_Min),r=this.m_Max.sub(this.m_Min),a=n.div(r);i.x=t.clamp(Math.ceil(a.x*this.m_Width),0,this.m_Width-1),i.y=t.clamp(Math.ceil(a.y*this.m_Height),0,this.m_Height-1)},e.prototype.Initialize=function(t,e,i,n){this.m_Width=i,this.m_Height=n,this.m_Min=t,this.m_Max=e,this.m_Count=0,this.Clear()},e.prototype.Add=function(t){var e=this.GetBucketVec(t.position);return e.push(t),++this.m_Count,t},e.prototype.Remove=function(t){for(var e=this.GetBucketVec(t.position),i=0;i<e.length;i++){var n=e[i];if(n.id==t.id){e.splice(i,1),--this.m_Count;break}}},e.prototype.FindInRange=function(e,i,n,r){this.m_CacheResult.length=0;var a=i*i,o=0,s=0,h=0,u=0,l=new t.Vector2,m=new t.Vector2;this.GetBucketIndex(e.sub(i),l),o=l.x,s=l.y,this.GetBucketIndex(e.add(i),m),h=m.x,u=m.y;for(var c=Math.cos(t.deg2rad*r*.5),f=o;h>=f;++f)for(var _=s;u>=_;++_)for(var p=this.GetBucket(f,_),d=0;d<p.length;d++){var y=p[d],S=y.position.sub(e),v=S.SquareMagnitude();if(a>=v){var B=S.div(Math.sqrt(v)),I=t.Dot(B,n);I>=c&&this.m_CacheResult.push(y)}}return this.m_CacheResult},e.prototype.FindInRangeFilter=function(e,i,n){this.m_CacheResult.length=0;var r=0,a=0,o=0,s=0,h=new t.Vector2,u=new t.Vector2;this.GetBucketIndex(e,h),r=h.x,a=h.y,this.GetBucketIndex(i,u),o=u.x,s=u.y;for(var l=r;o>=l;++l)for(var m=a;s>=m;++m)for(var c=this.GetBucket(l,m),f=0;f<c.length;++f)n.operator(f)&&this.m_CacheResult.push(f);return this.m_CacheResult},e.prototype.ExtractInRange=function(e,i,n){n.length=0;var r=0,a=0,o=0,s=0,h=new t.Vector2,u=new t.Vector2;this.GetBucketIndex(e,h),r=h.x,a=h.y,this.GetBucketIndex(i,u),o=u.x,s=u.y;for(var l=r;o>=l;++l)for(var m=a;s>=m;++m){var c=this.GetBucket(l,m);this.m_Count-=c.length,n=n.concat(c)}},e.prototype.Clear=function(){this.m_CacheResult.length=0,this.m_Bucket.length=0,this.m_Bucket.length=this.m_Width*this.m_Height,this.m_Count=0},e.prototype.Count=function(){return this.m_Count},e.prototype.Buckets=function(){return this.m_Bucket},e}();t.FixedSpatialItemContainer=i,__reflect(i.prototype,"snake.FixedSpatialItemContainer")}(snake||(snake={}));var snake;!function(t){t.FOLLOW_FACTOR=1,t.BEAN_MIN_DISTFACTOR=2,t.AI_VIEW_ASPECT=2,t.AVOID_ITERATION=3,t.BEAN_POS_REACH_DIST2=1,t.CIRCLING_DIST2=2.25,t.CIRCLING_TIME=5;var e;!function(t){t[t.Attacking=0]="Attacking",t[t.Eatting=1]="Eatting",t[t.Desperated=2]="Desperated"}(e=t.Strategy||(t.Strategy={}));var i=function(i){function n(){var n=i.call(this)||this;return n.m_CornerPos=new t.Vector2,n.m_SmoothTargetDirection=new t.Vector2,n.m_MostThreateningPos=new t.Vector2,n.m_AHeadPos=new t.Vector2,n.m_FollowPos=new t.Vector2,n.m_LastBeanPos=new t.Vector2,n.m_CirclingCheckPosition=new t.Vector2,n.m_LastThinkTime=-10,n.m_LastWanderTime=-10,n.m_LastAccelarateTime=-10,n.m_ThinkInterval=0,n.m_WanderInterval=0,n.m_AccelarateInterval=0,n.m_CirclingCheckTime=0,n.m_CirclingChecking=!1,n.m_LastAttackTarget=0,n.m_Strategy=e.Eatting,n.m_AvoidRadiusRT=0,n.m_Enable=!1,n.m_AIParams=new t.AIParams,n}return __extends(n,i),n.prototype.ExecuteStrategy=function(i,n,r){var a=new t.Vector2;switch(this.m_Strategy){case e.Eatting:this.FindBeanTarget(a,!1)?this.Follow(a,n):this.Wander(i,n),this.CanChangeStrategy(i)&&this.CanKill()&&t.uniform_random(0,1)<this.m_AIParams.agressive&&(this.m_Strategy=e.Attacking),this.CirclingCheck(i,t.CIRCLING_DIST2)&&(this.m_Strategy=e.Desperated),this.DoAccelarate(i,r);break;case e.Attacking:this.FindBeanTarget(a,!0)?this.Follow(a,n):0==this.m_LastAttackTarget||this.m_pScene.IsPlayerAlive(this.m_LastAttackTarget)?this.CanKill()&&this.FindAttackTarget(a)?(r=!0,this.Follow(a,n)):this.m_Strategy=e.Eatting:(this.m_Strategy=e.Eatting,this.m_LastAttackTarget=0),this.CirclingCheck(i,t.CIRCLING_DIST2)&&(this.m_Strategy=e.Desperated);break;case e.Desperated:this.CirclingCheck(i,2.5*t.CIRCLING_DIST2)?(this.Wander(i,n),r=!1):this.m_Strategy=e.Eatting}},n.prototype.CanChangeStrategy=function(e){return e-this.m_LastThinkTime>=this.m_ThinkInterval?(this.m_ThinkInterval=t.uniform_random(this.m_AIParams.minThinkInterval,this.m_AIParams.maxThinkInterval),this.m_LastThinkTime=e,!0):!1},n.prototype.CirclingCheck=function(e,i){if(this.m_CirclingChecking){var n=this.Width()/.32,r=this.Position().sub(this.m_CirclingCheckPosition);if(r.SquareMagnitude()>i*n*this.m_AIParams.desperateFactor)this.m_CirclingChecking=!1;else if(e-this.m_CirclingCheckTime>t.CIRCLING_TIME)return!0}else this.m_CirclingCheckPosition.vec=this.Position(),this.m_CirclingCheckTime=e,this.m_CirclingChecking=!0;return!1},n.prototype.Avoidance=function(i,n){if(this.m_Strategy!=e.Desperated){var r=0,a=new t.Vector2(0,0),o=new t.Vector2;o.SetVec(n);for(var s=new t.Vector2,h=0;h++<t.AVOID_ITERATION;){var u=t.Slerp(this.m_Direction,o,.5);if(!this.FindMostThreateningPos(u,a)){s=o;break}var l=this.m_Points[0].sub(a),m=l.Magnitude();if(m>1e-4){var c=this.m_AvoidRadiusRT/(m+1e-4);c>r&&(r=c,this.m_MostThreateningPos=a),o=l.divAssignment(m),s.addAssignment(o.mul(c))}}n=t.Normalize(s)}},n.prototype.Wander=function(e,i){e-this.m_LastWanderTime>=this.m_WanderInterval&&(i.SetVec(t.random_on_unitcircle()),this.m_WanderInterval=t.uniform_random(this.m_AIParams.minWanderInterval,this.m_AIParams.maxWanderInterval),this.m_LastWanderTime=e)},n.prototype.Follow=function(e,i){var n=t.Normalize(e.sub(this.m_Points[0])).mul(t.FOLLOW_FACTOR);i.addAssignment(n),i.vec=t.Normalize(i),this.m_FollowPos.vec=e},n.prototype.SmoothSteering=function(i){if(this.m_SmoothTargetDirection.IsZero())this.m_SmoothTargetDirection.vec=i;else{if(this.m_Strategy!=e.Attacking)this.m_SmoothTargetDirection.vec=i;else{var n=.5*(1-t.Dot(i,this.m_SmoothTargetDirection));n>.1&&(this.m_SmoothTargetDirection.vec=t.Slerp(this.m_SmoothTargetDirection,i,.2))}i.vec=this.m_SmoothTargetDirection}},n.prototype.DoAccelarate=function(e,i){e-this.m_LastAccelarateTime>=this.m_AccelarateInterval&&(this.m_AccelarateInterval=t.uniform_random(1,6),this.m_LastAccelarateTime=e,i=this.CanAccelarte()&&t.uniform_random(0,1)<this.m_AIParams.agile)},n.prototype.FindBeanTarget=function(e,i){if(this.m_AIParams.findBeanDist<1e-4)return!1;if(!this.m_LastBeanPos.IsZero()){var n=this.Position().sub(this.m_LastBeanPos);return n.SquareMagnitude()<t.BEAN_POS_REACH_DIST2?(this.m_LastBeanPos=new t.Vector2,!1):(e.vec=this.m_LastBeanPos,!0)}for(var r=this.m_pScene.WidthToView(this.Width())*this.m_AIParams.findBeanDist,a=this.m_Points[0],o=a.sub(r),s=a.add(r),h=this.m_pScene.Beans().FindInRangeFilter(o,s,new t.DefaultFilter),u=t.FLT_MAX,l=this.Speed().SquareMagnitude()/(this.m_pScene.Params().linearSpeedNormal*this.m_pScene.Params().linearSpeedNormal),m=this.Width()*t.BEAN_MIN_DISTFACTOR,c=m*m*l,f=this.m_pScene.Params().initialBeanMin,_=!1,p=h.length,d=0;p>d;++d){var y=h[d];if(!y.fromSlither){if(y.valReal<f)continue;if(i)continue}var S=y.position.sub(a).SquareMagnitude(),v=y.fromSlither?.1:1,B=S*v;S>c&&u>B&&(u=B,e.vec=y.position,this.m_LastBeanPos=e,_=!0)}return _},n.prototype.FindAttackTarget=function(e){var i=this.m_pScene.WidthToView(this.Width())*t.AI_VIEW_ASPECT,n=this.m_Points[0];if(0!=this.m_LastAttackTarget){var r=this.m_pScene.FindSlither(this.m_LastAttackTarget);if(null!=r){var a=r.Position(),o=a.sub(n).SquareMagnitude();if(i*i>o)return e.vec=a.add(r.Direction().mul(r.Width()*this.m_AIParams.aHeadDist)),!0}}this.m_LastAttackTarget=0;for(var s=t.AABB.createAABB(n.sub(i),n.sub(i)),h=0,u=null,l=this.m_pScene.FindSlithersInView(s),m=l.length,c=0;m>c;++c)if(l[c].ID()!=this.ID()){var f=(t.IsAI(this.ID()),1),_=f*l[c].Score();_>h&&(u=l[c],h=_)}return null!=u&&(e.vec=u.Position().add(u.Direction().mul(u.Width()*this.m_AIParams.aHeadDist)),this.m_LastAttackTarget=u.ID()),null!=u},n.prototype.FindMostThreateningPos=function(e,i){var n=this.m_pScene.Params(),r=Math.sqrt(this.Speed().Magnitude()/n.linearSpeedNormal),a=this.m_AIParams.aHeadDist*this.Width()*r;this.m_AHeadPos.vec=this.m_Points[0].add(e.mul(a)),this.m_AvoidRadiusRT=r*this.m_AIParams.avoidRadius*this.Width();for(var o=this.m_pScene.AllSlithers(),s=o.length,h=this.m_AvoidRadiusRT+a,u=t.FLT_MAX,l=!1,m=0;s>m;++m){var c=o[m];c.ID()!=this.m_SlitherInfo.id&&c.Bounds().IntersectVec(this.m_Points[0],h)&&this.FindSlitherPoint(c,this.m_AvoidRadiusRT,this.m_AHeadPos,i,u)&&(l=!0)}if(!l){var f=n.radius-this.m_AvoidRadiusRT-1,_=this.m_Points[0].sub(this.m_pScene.Center());_.SquareMagnitude()>f*f&&(i.vec=this.m_Points[0].add(t.Normalize(_).mul(this.m_AvoidRadiusRT)),l=!0)}return l},n.prototype.WayIntersects=function(t,e,i,n,r){var a=e+r;return a*=a,t.sub(n).SquareMagnitude()<a||i.sub(n).SquareMagnitude()<a},n.prototype.FindSlitherPoint=function(t,e,i,n,r){for(var a=this.m_pScene.Params(),o=t.PointData(),s=t.PointCount(),h=.5*t.Width(),u=!1,l=this.m_Points[0],m=0;s>m;++m){var c=o[m];if(this.WayIntersects(l,e,i,c,h)){var f=l.sub(c).SquareMagnitude();if(r>f){if(r=f,n=c,m<a.headTestStart&&this.Width()>t.Width())continue;u=!0}}}return u},n.prototype.CanAccelarte=function(){return this.Score()>this.m_pScene.Params().aiAccelarateMinScore},n.prototype.CanKill=function(){return this.CanAccelarte()&&this.Score()>this.m_pScene.Params().aiKillMinScore},n.prototype.Update=function(t,e){if(this.m_Enable){var n=this.m_TargetDirection,r=this.Accelarating();this.ExecuteStrategy(t,n,r),this.Avoidance(t,n),this.SmoothSteering(n),this.SetSlitherCmd(n,r)}i.prototype.Update.call(this,t,e)},n.prototype.EnableAI=function(t){this.m_Enable=t},n.prototype.IsEnableAI=function(){return this.m_Enable},n.prototype.SetAIParams=function(t){null!=t?(this.m_AIParams=t,this.m_ScoreFactor=this.m_AIParams.eatBeanFactor,this.m_Enable=!0):(this.m_ScoreFactor=1,this.m_Enable=!1)},n.prototype.GetAIParams=function(){return this.m_AIParams},n}(t.SlitherBase);t.Slither=i,__reflect(i.prototype,"snake.Slither")}(snake||(snake={}));var snake;!function(t){function e(e){return e<t.MAX_AI_ID}t.MAX_AI_ID=1e6,t.SPATIAL_NUM=40,t.ID_BUCKET_NUM=1e3,t.VIEW_ASPECT=2.2,t.IsAI=e;var i=function(){function t(){}return t.operator=function(t,e){return t.score>e.score?1:0},t}();t.SortSlitherInfo=i,__reflect(i.prototype,"snake.SortSlitherInfo");var n=function(){function t(){this.dieMap=new Object}return t.prototype.add=function(t,e){this.dieMap[t]=e},t.prototype.find=function(t){return this.dieMap[t]},t}();t.CollisionContext=n,__reflect(n.prototype,"snake.CollisionContext");var r=function(){function r(){this.m_PlayerTable=new t.ValMap,this.m_AITable=new t.ValMap,this.m_BeanTable=new t.FixedSpatialItemContainer,this.m_ViewTable=new t.ValMap,this.m_Center=new t.Vector2,this.m_HistorySlitherInfo=new t.ValMap,this.m_BeanIDQueue=[],this.m_ScoreWidth=[],this.m_ScoreLength=[],this.m_WidthView=[],this.m_WidthRotationNormal=[],this.m_WidthRotationFast=[],this.m_AllSlithers=[],this.m_CacheSlithersForQuery=[],this.m_CacheKillBean=[],this.m_CacheBeansForQuery=[],this.m_CacheBeanDevoured=[],this.m_CacheSlitherInfoForQuery=[],this.m_LastTime=-1,this.m_LastCompensateTime=-1,this.m_AIIDCounter=1,this.m_ViewIDCounter=1}return r.prototype.WriteBufferByte=function(t,e,i){t[e]=i},r.prototype.WriteBufferSlitherHeadInfo=function(t,e,i){var n=i.Info();t[e]=n.id,e+=1;var r=n.speed,a=n.head;return t[e]=r.x,e+=1,t[e]=r.y,e+=1,t[e]=a.x,e+=1,t[e]=a.y,e+=1,t[e]=n.length,e+=1,t[e]=n.width,e+=1,7},r.prototype.WriteBufferBirthDeathInfo=function(t,e,i){return t[e]=i.type,e+=1,t[e]=i.id,e+=1,2},r.prototype.WriteBufferSlitherBodyInfo=function(t,e,i,n){var r=n.PointCount();if(e+2*r+2>i)return 0;this.WriteBufferByte(t,e,n.ID()),e++,this.WriteBufferByte(t,e,r),e++;for(var a=n.Points(),o=0;r>o;++o){var s=a[o];this.WriteBufferByte(t,e,s.x),e++,this.WriteBufferByte(t,e,s.y),e++}return 2+2*r},r.prototype.AcquireBeanID=function(){var t=this.m_BeanIDQueue.shift();return t},r.prototype.ReleaseBeanID=function(t){this.m_BeanIDQueue.push(t)},r.prototype.FindSlither=function(t){return e(t)?this.m_AITable.find(t):this.m_PlayerTable.find(t)},r.prototype.ScroreToWidth=function(t){return this.ValueToValue(this.m_Params.scoreWidth,this.m_Params.scoreWidthCount,t)},r.prototype.ScoreToLength=function(t){return this.ValueToValue(this.m_Params.scoreLength,this.m_Params.scoreLengthCount,t)},r.prototype.WidthToView=function(t){return this.ValueToValue(this.m_Params.widthView,this.m_Params.widthViewCount,t)},r.prototype.WidthToRotateNormal=function(t){return this.ValueToValue(this.m_Params.widthRotateNormal,this.m_Params.widthRotateNormalCount,t)},r.prototype.WidthToRotateFast=function(t){return this.ValueToValue(this.m_Params.widthRotateFast,this.m_Params.widthRotateFastCount,t)},r.prototype.Beans=function(){return this.m_BeanTable},r.prototype.AllSlithers=function(){return this.m_AllSlithers},r.prototype.Params=function(){return this.m_Params},r.prototype.Center=function(){return this.m_Center},r.prototype.GetHistorySlitherInfo=function(t){return this.m_HistorySlitherInfo.find(t)},r.prototype.AllSlitherInfoByRank=function(){return this.m_CacheSlitherInfoForQuery},r.prototype.IsPlayerAlive=function(t){return null!=this.FindSlither(t)},r.prototype.GetAllSlitherCount=function(){return this.GetAICount()+this.GetPlayerCount()},r.prototype.ConfineInRange=function(t,e,i){if(0>=i)return t;var n=t.sub(e),r=n.Magnitude();return r>i?n.divAssignment(r).mulAssignment(i).addAssignment(e):t},r.prototype.IsPositionFit=function(t,e,i){for(var n=i.length,r=0;n>r;++r){var a=i[r].Bounds();if(a.IntersectVec(t,e))return!1}return!0},r.prototype.RemoveSlither=function(t,e){for(var i=t.length-1;i>=0;--i)if(t[i].ID()==e)return void t.splice(i,1)},r.prototype.ContainsSlitherID=function(t,e){for(var i=t.length-1;i>=0;--i)if(t[i].ID()==e)return!0;return!1},r.prototype.ClampInBorder=function(t,e,i){var n=t.sub(e),r=n.SquareMagnitude();return r>i*i?n.mulAssignment(i).divAssignment(Math.sqrt(r)).addAssignment(e):t},r.prototype.Initialize=function(e){this.m_ScoreWidth.length=0,this.m_ScoreWidth=this.m_ScoreWidth.concat(e.scoreWidth),this.m_ScoreLength.length=0,this.m_ScoreLength=this.m_ScoreLength.concat(e.scoreLength),this.m_WidthView.length=0,this.m_WidthView=this.m_WidthView.concat(e.widthView),this.m_WidthRotationNormal.length=0,this.m_WidthRotationNormal=this.m_WidthRotationNormal.concat(e.widthRotateNormal),this.m_WidthRotationFast.length=0,this.m_WidthRotationFast=this.m_WidthRotationFast.concat(e.widthRotateFast),this.m_Params=e,this.m_Params.scoreWidth=this.m_ScoreWidth,this.m_Params.scoreLength=this.m_ScoreLength,this.m_Params.widthView=this.m_WidthView,this.m_Params.widthRotateNormal=this.m_WidthRotationNormal,this.m_Params.widthRotateFast=this.m_WidthRotationFast;var i=e.radius;this.m_Center.SetTo(i,i),this.m_BeanTable.Initialize(this.m_Center.sub(i),this.m_Center.add(i),t.SPATIAL_NUM,t.SPATIAL_NUM),this.ResetBeanIDQueue(),this.AdjustInitialBeans()},r.prototype.AdjustInitialBeans=function(){var e,i=Math.sqrt(this.m_Params.radius)*this.m_Params.initialBeanSigma,n=this.m_Params.radius-1;for(n*=n;this.m_BeanTable.Count()<Math.ceil(this.m_Params.initialBeanCount);){var r=t.random_gaussian_disk(i);r.SquareMagnitude()<n&&(e=new t.Bean,e.position.vec=this.m_Center.add(r),e.id=this.AcquireBeanID(),e.valReal=t.uniform_random(this.m_Params.initialBeanMin,this.m_Params.initialBeanMax),e.valVisual=e.valReal*this.m_Params.scoreVisualScale,e.slitherID=0,e.fromSlither=!1,this.m_BeanTable.Add(e))}},r.prototype.ResetBeanIDQueue=function(){this.m_BeanIDQueue.length=0;for(var t=1;1e4>t;++t)this.m_BeanIDQueue.push(t)},r.prototype.AdjustSceneParams=function(t){this.m_Params.initialBeanCount=t.initialBeanCount,this.m_Params.compensateBeanThreshold=t.compensateBeanThreshold,this.AdjustInitialBeans()},r.prototype.ValueToValue=function(e,i,n){if(0==i)return 0;for(var r=i-1,a=0;i>a;++a)if(e[a].x>=n){r=a;break}if(0==r)return e[0].y;var o=(n-e[r-1].x)/(e[r].x-e[r-1].x);return t.lerp(e[r-1].y,e[r].y,o)},r.prototype.UpdateScene=function(t){this.m_CacheBeanDevoured.length=0;var e=new n;this.UpdateKillBeanDevour(),this.UpdateMove(t),this.UpdateCollision(e),this.UpdateView(),this.UpdateCacheSlitherInfoForQuery(),this.CompensateBeans(t),this.NotifyBeanDevoured()},r.prototype.UpdateMove=function(t){this.m_LastTime<0&&(this.m_LastTime=t);var e=t-this.m_LastTime;this.m_LastTime=t;for(var i=this.m_AllSlithers.length,n=0;i>n;++n){var r=this.m_AllSlithers[n];r.Update(t,e)}},r.prototype.UpdateCollision=function(t){for(var i=this.m_AllSlithers.length,n=0;i>n;++n){var r=this.m_AllSlithers[n];r.UpdateCollision(t)}this.UpdateHistorySlitherInfo(t);for(var a in t.dieMap){var o=t.dieMap[a],r=this.FindSlither(o);null!=r&&(this.RemoveSlither(this.m_AllSlithers,o),e(o)?this.m_AITable.remove(o):this.m_PlayerTable.remove(o))}},r.prototype.UpdateHistorySlitherInfo=function(t){for(var e=this.m_AllSlithers.length,i=0;e>i;++i){var n=this.m_AllSlithers[i],r=n.ID(),a=this.m_HistorySlitherInfo.find(r),o=n.Info();null==a?a=this.m_HistorySlitherInfo.add(r,o):this.m_HistorySlitherInfo.setVal(r,o)}},r.prototype.CompensateBeans=function(e){if(!(e-this.m_LastCompensateTime<this.m_Params.compensateBeanInterval)){for(var i=this.m_AllSlithers.length,n=0;i>n;++n){var r=this.m_AllSlithers[n];if(r.Score()<this.m_Params.compensateBeanThreshold){var a=r.Position(),o=t.Normalize(this.m_Center.sub(a));a.addAssignment(o.mul(this.m_Params.compensateBeanDistance)),a.addAssignment(t.random_in_unitcircle().mulAssignment(this.m_Params.compensateBeanRadius));for(var s=0;s<this.m_Params.compensateBeanCount;++s){var h=a.add(t.random_in_unitcircle());h=this.ClampInBorder(h,this.Center(),.9*this.m_Params.radius);var u=t.uniform_random(this.m_Params.initialBeanMin,this.m_Params.initialBeanMax);this.GenerateBean(h,u*this.m_Params.scoreVisualScale,u)}}}this.m_LastCompensateTime=e}},r.prototype.NotifyBeanDevoured=function(){for(var t=this.m_ViewTable.list,e=t.length,i=0;e>i;++i)t[i].NotifyBeanDevoured(this.m_CacheBeanDevoured)},r.prototype.UpdateCacheSlitherInfoForQuery=function(){var t=this.m_AllSlithers.length,e=this.m_CacheSlitherInfoForQuery;e.length=0;for(var n=0;t>n;++n){var r=this.m_AllSlithers[n];e.push(r.Info())}e.sort(i.operator);for(var n=0;t>n;++n){var a=e[n].id,r=this.FindSlither(a);null!=r&&r.setRank(n+1),e[n].rank=n+1}},r.prototype.UpdateKillBeanDevour=function(){for(var t=this.m_CacheKillBean.length,e=0;t>e;++e){var i=this.m_CacheKillBean[e];this.DevourBean(i,i.slitherID,!0)}this.m_CacheKillBean.length=0},r.prototype.UpdateView=function(){for(var t=this.m_ViewTable.list,e=t.length,i=0;e>i;++i)t[i].Update()},r.prototype.CreateSlitherAI=function(e,i,n,r,a){if(t.Distance(r,this.m_Center)>=this.m_Params.radius)return 0;var o=this.m_AIIDCounter++%t.MAX_AI_ID,s=this.m_AITable.add(o,new t.Slither);return s.Initialize(this,o,i,e,r,a),s.SetAIParams(n),this.m_AllSlithers.push(s),o},r.prototype.CreateSlitherPlayer=function(e,i,n,r,a){if(this.IsPlayerAlive(e))return!1;var o=this.m_PlayerTable.add(e,new t.Slither);return o.Initialize(this,e,n,i,r,a),this.m_AllSlithers.push(o),!0},r.prototype.SetSlitherAI=function(t,e){var i=this.FindSlither(t);null!=i&&i.SetAIParams(e)},r.prototype.SetSlitherPlayerCmd=function(t,e,i){var n=this.FindSlither(t);null!=n&&n.SetSlitherCmd(e,i)},r.prototype.FindBestFitPosition=function(e,i,n,r,a){var o=.8,s=0;if(r.IsZero())if(n){for(var h=new t.Vector2;i>s;){var u=1-s/i,l=this.m_Center.add(t.random_on_unitcircle().mulAssignment(u*this.m_Params.radius*o));if(++s,h.IsZero()&&h.SetVec(l),this.IsPositionFit(l,e,this.m_AllSlithers))return a.SetVec(l),!0}a.SetVec(h)}else for(;i>s;){var l=t.random_in_unitcircle().mulAssignment(this.m_Params.radius*o).addAssignment(this.m_Center);if(a.SetVec(l),++s,this.IsPositionFit(l,e,this.m_AllSlithers))return!0}else for(;i>s;){var u=(s+1)/i,l=t.random_on_unitcircle().mulAssignment(u*this.m_Params.radius).addAssignment(r);if(l=this.ConfineInRange(l,this.m_Center,this.m_Params.radius*o),a.SetVec(l),++s,this.IsPositionFit(l,e,this.m_AllSlithers))return!0}return!1},r.prototype.DevourBean=function(e,i,n){var r=e.id,a=new t.BeanDevoured;a.id=e.id,a.position.vec=e.position,a.slitherID=i,a.kill=n,this.m_CacheBeanDevoured.push(a),this.m_BeanTable.Remove(e),this.ReleaseBeanID(r)},r.prototype.GenerateBean=function(e,i,n){var r=new t.Bean;r.id=this.AcquireBeanID(),r.position.vec=e,r.valReal=n,r.valVisual=i,r.slitherID=0,r.fromSlither=!1,this.m_BeanTable.Add(r)},r.prototype.GenerateBeanOnSlitherDie=function(e,i){for(var n,r=e.Width(),a=e.Points(),o=e.PointCount(),s=this.m_Params,h=Math.ceil(r*o*s.dieScoreCountRatio),u=h/o,l=(s.dieScoreBase+e.Score()*s.dieScorePercent)/h,m=0,c=0;o>c;++c){var f=u+m,_=Math.ceil(f);m=f-_;for(var p=0;_>p;++p){var d=t.random_in_unitcircle().mulAssignment(.5*r*s.dieScoreRandOffset);n.id=this.AcquireBeanID(),n.position.vec=a[c].add(d),n.valReal=l,n.valVisual=s.dieScoreVisualScale*r,n.slitherID=0,n.fromSlither=!0,this.m_BeanTable.Add(n)}}var y=t.min(o,s.killBeanMaxPoint),S=s.killBeanScoreRatio*e.Score();l=S/s.killBeanCount;for(var c=0;c<s.killBeanCount;++c){var v=t.uniform_random(0,.99999)*y,d=t.random_in_unitcircle().mulAssignment(.5*r*s.dieScoreRandOffset);n.id=this.AcquireBeanID(),n.position.vec=a[v].add(d),n.valReal=l,n.valVisual=s.dieScoreVisualScale*r,n.slitherID=i.ID(),n.fromSlither=!1,this.m_CacheKillBean.push(this.m_BeanTable.Add(n))}i.AddScore(S)},r.prototype.DeleteAllBeans=function(){for(var e,i=this.m_BeanTable.Buckets(),n=i.length,r=0;n>r;++r)for(var a=i[r],o=a.length,s=0;o>s;++s){var h=a[s];e=new t.BeanDevoured,e.id=h.id,e.position.vec=h.position,e.slitherID=0,e.kill=!1,this.m_CacheBeanDevoured.push(e)}this.m_BeanTable.Clear(),this.ResetBeanIDQueue()},r.prototype.DeleteAllSlithers=function(){this.m_AITable.clear(),this.m_PlayerTable.clear(),this.m_AllSlithers.length=0,this.m_CacheSlithersForQuery.length=0,this.m_CacheSlitherInfoForQuery.length=0},r.prototype.GetBeanCount=function(){return this.m_BeanTable.Count()},r.prototype.GetAICount=function(){return this.m_AITable.size()},r.prototype.GetPlayerCount=function(){return this.m_PlayerTable.size()},r.prototype.QueryRankSyncData=function(e,i,n){var r=0,a=this.m_CacheSlitherInfoForQuery.length;
if(e=t.min(e,a),0==e)return 0;if(6+14*e>n)return 0;this.WriteBufferByte(i,r,e),r++;for(var o=0;e>o;++o){var s=this.m_CacheSlitherInfoForQuery[o];this.WriteBufferByte(i,r,s.id),r++,this.WriteBufferByte(i,r,s.score*this.m_Params.scoreScale),r++,this.WriteBufferByte(i,r,s.inTeamNum),r++,this.WriteBufferByte(i,r,0),r++}return this.WriteBufferByte(i,r,a),r++,r},r.prototype.QueryMiniMapSyncData=function(e,i,n){var r=0,a=this.m_CacheSlitherInfoForQuery.length;if(e=t.min(e,a),0==e)return 0;if(18+14*e>n)return 0;this.WriteBufferByte(i,r,e),r++;for(var o=0;e>o;++o){var s=this.m_CacheSlitherInfoForQuery[o];this.WriteBufferByte(i,r,s.id),r++,this.WriteBufferByte(i,r,s.head.x),r++,this.WriteBufferByte(i,r,s.head.y),r++,this.WriteBufferByte(i,r,0),r++}return this.WriteBufferByte(i,r,0),r++,this.WriteBufferByte(i,r,0),r++,this.WriteBufferByte(i,r,0),r++,this.WriteBufferByte(i,r,0),r++,r},r.prototype.CreateView=function(e){var i=new t.View,n=this.m_ViewIDCounter++;return i.Initialize(this,n,e),this.m_ViewTable.add(n,i),n},r.prototype.DeleteView=function(t){this.m_ViewTable.remove(t)},r.prototype.FindSlithersInView=function(t){this.m_CacheSlithersForQuery.length=0;for(var e=this.m_AllSlithers.length,i=0;e>i;++i){var n=this.m_AllSlithers[i];n.Bounds().Intersect(t)&&this.m_CacheSlithersForQuery.push(n)}return this.m_CacheSlithersForQuery},r.prototype.BuildBirthDeath=function(t,e,i){if(0==t.length)return 0;for(var n=0,r=1,a=t.length,o=0;a>o&&!(2>i-r);++o)++n,this.WriteBufferBirthDeathInfo(e,r,t[o]),r+=2;return this.WriteBufferByte(e,0,n),r},r.prototype.BuildHeadSyncData=function(t,e,i){for(var n=0,r=1,a=t.length,o=0;a>o&&!(7>i-r);++o)++n,this.WriteBufferSlitherHeadInfo(e,r,t[o]),r+=7;return this.WriteBufferByte(e,0,n),r},r.prototype.BuildInfoSyncData=function(t,e,i){var n=0;return null!=t&&(this.WriteBufferByte(e,n,t.rank),n++,this.WriteBufferByte(e,n,t.continueKillCount),n++,this.WriteBufferByte(e,n,t.totalKillCount),n++,this.WriteBufferByte(e,n,t.score*this.m_Params.scoreScale),n++),n},r.prototype.BuildBodySyncData=function(t,e,i){for(var n=0,r=1,a=t.length,o=0;a>o;++o){var s=this.WriteBufferSlitherBodyInfo(e,r,i,t[o]);if(0==s)break;r+=s,++n}var h=0;return this.WriteBufferByte(e,h,n),r},r.prototype.BuildBeanSpawnSyncData=function(t,e,i){var n=t.length;if(0==n)return 0;var r=1;if(4*n>i-r)return 0;for(var a=t.length,o=0;a>o;++o){var s=t[o],h=s.position;this.WriteBufferByte(e,r++,s.id),this.WriteBufferByte(e,r++,h.x),this.WriteBufferByte(e,r++,h.y),this.WriteBufferByte(e,r++,s.valVisual)}return this.WriteBufferByte(e,0,n),r},r.prototype.BuildBeanDevouredSyncData=function(t,e,i,n){var r=t.length;if(0==r)return 0;var a=0;if(2+1*r+1*r>n-a)return 0;this.WriteBufferByte(i,a++,e?1:0);var o=a;a+=1;for(var s=0,h=0;r>h;++h){var u=t[h];this.WriteBufferByte(i,a++,u.id),++s}this.WriteBufferByte(i,o,s),this.WriteBufferByte(i,a++,s);for(var h=0;r>h;++h){var u=t[h];this.WriteBufferByte(i,a++,u.slitherID)}return t.length=0,a},r.prototype.QueryPlayerBirthDeath=function(e,i,n){var r=this.m_ViewTable.find(e);if(null==r)return 0;var a=0,o=0,s=[],h=r.SlithersInView(),u=[],l=this.FindSlithersInView(r.Bounds());for(a=0,o=h.length,a=0;o>a;++a){var m=h[a];if(!this.ContainsSlitherID(l,m)){var c=new t.BirthDeathInfo;c.type=t.BirthDeathType.ExitView,c.id=m,s.push(c)}}for(o=l.length,a=0;o>a;++a){var m=l[a].ID();if(u.push(m),-1==h.indexOf(m)){var c=new t.BirthDeathInfo;c.type=t.BirthDeathType.EnterView,c.id=m,s.push(c)}}for(o=h.length=u.length,a=0;o>a;a++)h[a]=u[a];return this.BuildBirthDeath(s,i,n)},r.prototype.QueryPlayerHeadSyncData=function(t,e,i){var n=this.m_ViewTable.find(t);return null==n?0:this.BuildHeadSyncData(this.FindSlithersInView(n.Bounds()),e,i)},r.prototype.QueryPlayerInfoSyncData=function(t,e,i){var n=this.m_ViewTable.find(t);return null==n?0:this.BuildInfoSyncData(n.GetSlitherInfo(),e,i)},r.prototype.QueryPlayerBodySyncData=function(t,e,i){var n=this.m_ViewTable.find(t);return null==n?0:this.BuildBodySyncData(this.FindSlithersInView(n.Bounds()),e,i)},r.prototype.QueryPlayerBeanSpawnData=function(e,i,n){var r=this.m_ViewTable.find(e);if(null==r)return 0;var a=this.m_BeanTable.FindInRangeFilter(r.Bounds().min,r.Bounds().max,new t.ViewBeanFilter(r));return this.BuildBeanSpawnSyncData(a,i,n)},r.prototype.QueryPlayerBeanDevouredData=function(t,e,i,n){var r=this.m_ViewTable.find(t);return null==r?0:this.BuildBeanDevouredSyncData(e?r.DevouredKillBeans():r.DevouredBeans(),e,i,n)},r.prototype.QueryPlayerBeanRefreshData=function(e,i,n){var r=this.m_ViewTable.find(e);if(null==r)return 0;r.ResetBeanHistory();var a=this.m_BeanTable.FindInRangeFilter(r.Bounds().min,r.Bounds().max,new t.ViewBeanFilter(r));return this.BuildBeanSpawnSyncData(a,i,n)},r}();t.Scene=r,__reflect(r.prototype,"snake.Scene")}(snake||(snake={}));var snake;!function(t){var e=function(){function e(){this.position=new t.Vector2}return e}();t.Bean=e,__reflect(e.prototype,"snake.Bean");var i=function(){function e(){this.position=new t.Vector2}return e}();t.BeanDevoured=i,__reflect(i.prototype,"snake.BeanDevoured")}(snake||(snake={}));var snake;!function(t){var e=function(){function e(){this.m_BeanDevouredList=[],this.m_KillBeanDevouredList=[],this.m_SlithersInView=[],this.m_AABB=new t.AABB,this.m_ViewID=0,this.m_SlitherID=0}return e.prototype.Initialize=function(e,i,n){this.m_pScene=e,this.m_ViewID=i,this.m_SlitherID=n,this.m_BeanDevouredList.length=0,this.m_BeanQueriedTable=new t.UIntSet,this.m_BeanQueriedTable.Initialize(t.ID_BUCKET_NUM),0==this.m_SlitherID&&(this.m_AABB=new t.AABB,this.m_AABB.min=this.m_pScene.Center().sub(this.m_pScene.Params().radius),this.m_AABB.max=this.m_pScene.Center().sub(this.m_pScene.Params().radius))},e.prototype.Update=function(){var e=this.m_pScene.FindSlither(this.m_SlitherID);if(null!=e){var i=e.Position(),n=this.m_pScene.WidthToView(e.Width())*t.VIEW_ASPECT;this.m_AABB.min=i.sub(n),this.m_AABB.max=i.add(n)}},e.prototype.GetSlitherInfo=function(){return this.m_pScene.GetHistorySlitherInfo(this.m_SlitherID)},e.prototype.ResetBeanHistory=function(){this.m_BeanQueriedTable.Clear(),this.m_KillBeanDevouredList.length=0,this.m_BeanDevouredList.length=0},e.prototype.FilterBean=function(t){return this.m_BeanQueriedTable.Contains(t.id)?!1:(this.m_BeanQueriedTable.Add(t.id),!0)},e.prototype.NotifyBeanDevoured=function(t){for(var e=t.length,i=0;e>i;++i){var n=t[i];this.m_BeanQueriedTable.Contains(n.id)&&(n.kill?this.m_KillBeanDevouredList.push(n):this.m_BeanDevouredList.push(n),this.m_BeanQueriedTable.Remove(n.id))}},e.prototype.Bounds=function(){return this.m_AABB},e.prototype.DevouredBeans=function(){return this.m_BeanDevouredList},e.prototype.DevouredKillBeans=function(){return this.m_KillBeanDevouredList},e.prototype.SlithersInView=function(){return this.m_SlithersInView},e}();t.View=e,__reflect(e.prototype,"snake.View");var i=function(t){function e(e){var i=t.call(this)||this;return i.view=e,i}return __extends(e,t),e.prototype.operator=function(t){return this.view.FilterBean(t)},e}(t.DefaultFilter);t.ViewBeanFilter=i,__reflect(i.prototype,"snake.ViewBeanFilter")}(snake||(snake={}));var snake;!function(t){var e=function(){function t(){this.v=new Object}return t.prototype.add=function(t,e){this.v[t]=e},t}();t.unordered_map=e,__reflect(e.prototype,"snake.unordered_map");var i=function(){function t(){this.v=new Object}return t.prototype.add=function(t,e){this.v[t]=e},t}();t.unordered_set=i,__reflect(i.prototype,"snake.unordered_set")}(snake||(snake={}));var snake;!function(t){function e(t){return null!=t?V.CreateScene(t):0}function i(t,e){if(null!=e){var i=V.GetScene(t);null!=i&&i.AdjustSceneParams(e)}}function n(t,e){var i=V.GetScene(t);null!=i&&i.UpdateScene(e)}function r(t){V.DeleteScene(t)}function a(t){var e=V.GetScene(t);null!=e&&e.DeleteAllBeans()}function o(t){var e=V.GetScene(t);null!=e&&e.DeleteAllSlithers()}function s(t,e,i,n,r,a){var o=V.GetScene(t);return null!=o&&null!=r&&null!=a?o.CreateSlitherAI(e,i,n,r,a):0}function h(t,e,i,n,r,a){var o=V.GetScene(t);return null!=o&&null!=r&&null!=a?o.CreateSlitherPlayer(e,i,n,r,a):!1}function u(t,e,i){var n=V.GetScene(t);null!=n&&n.SetSlitherAI(e,i)}function l(t,e,i,n){var r=V.GetScene(t);null!=r&&null!=i&&r.SetSlitherPlayerCmd(e,i,n)}function m(e,i,n,r,a,o){var s=V.GetScene(e);return null!=s&&null!=o?s.FindBestFitPosition(i,n,r,null==a?new t.Vector2:a,o):!1}function c(t,e){var i=V.GetScene(t);return null!=i?i.GetHistorySlitherInfo(e):null}function f(t,e,i,n){var r=V.GetScene(t);null!=r&&null!=e&&r.GenerateBean(e,i,n)}function _(t,e){var i=V.GetScene(t);return null!=i?i.IsPlayerAlive(e):!1}function p(t){if(0==t)return V.GetBeanCount();var e=V.GetScene(t);return null!=e?e.GetBeanCount():0}function d(t){if(0==t)return V.GetAICount();var e=V.GetScene(t);return null!=e?e.GetAICount():0}function y(t){if(0==t)return V.GetPlayerCount();var e=V.GetScene(t);return null!=e?e.GetPlayerCount():0}function S(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryRankSyncData(e,i,n):0}function v(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryMiniMapSyncData(e,i,n):0}function B(t,e){var i=V.GetScene(t);return null!=i?i.CreateView(e):0}function I(t,e){var i=V.GetScene(t);return null!=i?i.DeleteView(e):void 0}function g(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryPlayerBirthDeath(e,i,n):0}function A(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryPlayerHeadSyncData(e,i,n):0}function P(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryPlayerInfoSyncData(e,i,n):0}function D(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryPlayerBodySyncData(e,i,n):0}function C(t,e,i,n){return 0}function T(t,e,i,n){return 0}function w(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryPlayerBeanSpawnData(e,i,n):0}function k(t,e,i,n,r){var a=V.GetScene(t);return null!=a?a.QueryPlayerBeanDevouredData(e,i,n,r):0}function x(t,e,i,n){var r=V.GetScene(t);return null!=r?r.QueryPlayerBeanRefreshData(e,i,n):0}var V=new t.SceneManager;t.CreateScene=e,t.SnakeAdjustSceneParams=i,t.UpdateScene=n,t.DeleteScene=r,t.DeleteAllBeans=a,t.DeleteAllSlithers=o,t.CreateSlitherAI=s,t.CreateSlitherPlayer=h,t.SetSlitherAI=u,t.SetSlitherPlayerCmd=l,t.FindBestFitPosition=m,t.GetSlitherInfo=c,t.SnakeGenerateBean=f,t.IsPlayerAlive=_,t.GetBeanCount=p,t.GetAICount=d,t.GetPlayerCount=y,t.QueryRankSyncData=S,t.QueryMiniMapSyncData=v,t.CreateView=B,t.DeleteView=I,t.QueryPlayerBirthDeath=g,t.QueryPlayerHeadSyncData=A,t.QueryPlayerInfoSyncData=P,t.QueryPlayerBodySyncData=D,t.QueryPlayerBodySyncBaseData=C,t.QueryPlayerBodySyncFactorData=T,t.QueryPlayerBeanSpawnData=w,t.QueryPlayerBeanDevouredData=k,t.QueryPlayerBeanRefreshData=x}(snake||(snake={}));var snake;!function(t){var e=function(){function t(){}return t}();t.SceneParams=e,__reflect(e.prototype,"snake.SceneParams");var i=function(){function t(){}return t}();t.SceneAdjustableParams=i,__reflect(i.prototype,"snake.SceneAdjustableParams");var n=function(){function t(){}return t}();t.AIParams=n,__reflect(n.prototype,"snake.AIParams");var r=function(){function t(){}return t}();t.SlitherInfo=r,__reflect(r.prototype,"snake.SlitherInfo");var a;!function(t){t[t.EnterView=1]="EnterView",t[t.ExitView=2]="ExitView"}(a=t.BirthDeathType||(t.BirthDeathType={}));var o=function(){function t(){}return t}();t.BirthDeathInfo=o,__reflect(o.prototype,"snake.BirthDeathInfo")}(snake||(snake={}));var snake;!function(t){var e=function(){function t(){}return t.prototype.Initialize=function(t){this.m_Max=t,this.m_Bucket=[],this.m_Bucket.length=t,this.m_Count=0},t.prototype.GetBucket=function(t){var e=t%this.m_Max,i=this.m_Bucket[e];return i?i:i=this.m_Bucket[e]=new Array},t.prototype.Add=function(t){var e=this.GetBucket(t);-1==e.indexOf(t)&&(e.push(t),++this.m_Count)},t.prototype.Remove=function(t){var e=this.GetBucket(t),i=e.indexOf(t);-1!=i&&(e.splice(i,1),--this.m_Count)},t.prototype.Contains=function(t){var e=this.GetBucket(t);return-1!=e.indexOf(t)},t.prototype.Clear=function(){this.m_Bucket.length=0,this.m_Bucket.length=this.m_Max,this.m_Count=0},t.prototype.Count=function(){return this.m_Count},t}();t.UIntSet=e,__reflect(e.prototype,"snake.UIntSet")}(snake||(snake={}));var snake;!function(t){t.FLT_MIN=1.175494351e-38,t.FLT_MAX=3.402823466e38;var e=function(){function e(){this.min=new t.Vector2(t.FLT_MAX,t.FLT_MAX),this.max=new t.Vector2(-t.FLT_MAX,-t.FLT_MAX)}return e.createAABB=function(t,i){var n=new e;return n.min=t,n.max=i,n},e.createAB=function(t){var i=new e;return i.min=t.min,i.max=t.max,i},e.prototype.equal=function(t){return this.min.SetVec(t.min),this.max.SetVec(t.max),this},e.prototype.Clear=function(){this.min=new t.Vector2(t.FLT_MAX,t.FLT_MAX),this.max=new t.Vector2(-t.FLT_MAX,-t.FLT_MAX)},e.prototype.IsValid=function(){return this.max.x>=this.min.x&&this.max.y>=this.min.y},e.prototype.Encapuslate=function(e){var i=this.min,n=this.max;i.x=t.min(i.x,e.x),i.y=t.min(i.y,e.y),n.x=t.max(n.x,e.x),n.y=t.max(n.y,e.y)},e.prototype.Contains=function(t){var e=this.min,i=this.max;return e.x<=t.x&&e.y<=t.y&&t.x<=i.x&&t.y<=i.y},e.prototype.Extents=function(){return this.max.sub(this.min).mul(.5)},e.prototype.Center=function(){return this.max.add(this.min).mul(.5)},e.prototype.Size=function(){return this.max.sub(this.min)},e.prototype.Enlarge=function(t){if("number"==typeof t){var e=t;this.min.subAssignment(e),this.max.addAssignment(e)}else this.min.subAssignment(t),this.max.addAssignment(t)},e.prototype.Intersect=function(t){var e=t.Extents(),i=t.Center(),n=this.min.sub(e),r=this.max.add(e);return n.x<=i.x&&n.y<=i.y&&i.x<=r.x&&i.y<=r.y},e.prototype.IntersectVec=function(t,e){var i,n=this.Center(),r=t.sub(n),a=this.Extents();r.x<-a.x?i.x=-a.x:r.x>a.x?i.x=a.x:i.x=r.x,r.y<-a.y?i.y=-a.y:r.y>a.y?i.y=a.y:i.y=r.y;var o=r.subAssignment(i);return o.SquareMagnitude()<e*e},e}();t.AABB=e,__reflect(e.prototype,"snake.AABB")}(snake||(snake={}));var snake;!function(t){function e(t,e){return t.x*e.x+t.y*e.y}function i(t,e){return e.mul(t)}function n(t){var e=t.SquareMagnitude();if(e>1e-6){var i=1/Math.sqrt(e);return t.mul(i)}return new c(1,0)}function r(t,i){return t.add(i.mul(-2*e(t,i)))}function a(t){return new c(t.y,-t.x)}function o(t,e){return t.sub(e).Magnitude()}function s(i,n,r){var a=t.clamp(e(i,n),-.99,.99),o=Math.acos(a),s=i.mul(Math.sin((1-r)*o)),h=n.mul(Math.sin(r*o)),u=s.add(h).div(Math.sin(o));return u.IsValid()?u:i}function h(i,n,r){var a=t.clamp(e(i,n),-.99,.99),o=Math.acos(a);if(r>=o)return n;var s=r/o,h=i.mul(Math.sin((1-s)*o)),u=n.mul(Math.sin(s*o)),l=h.add(u).div(Math.sin(o));return l.IsValid()?l:i}function u(){var e=t.uniform_random(0,2*t._PI);return new c(Math.cos(e),Math.sin(e))}function l(){var e=t.uniform_random(0,2*t._PI),i=t.uniform_random(0,1);return new c(i*Math.cos(e),i*Math.sin(e))}function m(e){return void 0===e&&(e=1),new c(t.gaussian_random(e),t.gaussian_random(e))}var c=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.SetVec=function(t){this.x=t.x,this.y=t.y},Object.defineProperty(t.prototype,"vec",{set:function(t){this.x=t.x,this.y=t.y},enumerable:!0,configurable:!0}),t.prototype.SetTo=function(t,e){this.x=t,this.y=e},t.prototype.equal=function(t){return this.x==t.x&&this.y==t.y},t.prototype.noequal=function(t){return this.x!=t.x&&this.y!=t.y},t.prototype.add=function(e){return"number"==typeof e?new t(this.x+e,this.y+e):new t(this.x+e.x,this.y+e.y)},t.prototype.sub=function(e){return"number"==typeof e?new t(this.x-e,this.y-e):new t(this.x-e.x,this.y-e.y)},t.prototype.mul=function(e){return"number"==typeof e?new t(this.x*e,this.y*e):new t(this.x*e.x,this.y*e.y)},t.prototype.div=function(e){return"number"==typeof e?new t(this.x/e,this.y/e):new t(this.x/e.x,this.y/e.y)},t.prototype.addAssignment=function(t){return"number"==typeof t?(this.x+=t,this.y+=t):(this.x+=t.x,this.y+=t.y),this},t.prototype.subAssignment=function(t){return"number"==typeof t?(this.x-=t,this.y-=t):(this.x-=t.x,this.y-=t.y),this},t.prototype.mulAssignment=function(t){return"number"==typeof t?(this.x*=t,this.y*=t):(this.x*=t.x,this.y*=t.y),this},t.prototype.divAssignment=function(t){return"number"==typeof t?(this.x/=t,this.y/=t):(this.x/=t.x,this.y/=t.y),this},t.prototype.Magnitude=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.SquareMagnitude=function(){var t=this.x,e=this.y;return t*t+e*e},t.prototype.IsZero=function(){return 0==this.x&&0==this.y},t.prototype.IsValid=function(){return isNaN(this.x)||isNaN(this.y)?!1:!0},t}();t.Vector2=c,__reflect(c.prototype,"snake.Vector2"),t.Dot=e,t.operatorMul=i,t.Normalize=n,t.Reflect=r,t.Right=a,t.Distance=o,t.Slerp=s,t.RotateTowards=h,t.random_on_unitcircle=u,t.random_in_unitcircle=l,t.random_gaussian_disk=m}(snake||(snake={}));var snake;!function(t){function e(t,e){return e>t?t:e}function i(t,e){return t>e?t:e}function n(t,e,i){return e>t?e:t>i?i:t}function r(t,e,i){return i*e+(1-i)*t}function a(t){return n(t,0,1)}function o(t,e){return t+Math.random()*(e-t)}function s(e){void 0===e&&(e=1);var i=Math.random(),n=Math.random(),r=Math.sqrt(-2*Math.log(i))*Math.sin(2*t._PI*n);return e*r}t._PI=3.141592654,t.deg2rad=t._PI/180,t.rad2deg=180/t._PI,t.min=e,t.max=i,t.clamp=n,t.lerp=r,t.saturate=a,t.uniform_random=o,t.gaussian_random=s}(snake||(snake={}));